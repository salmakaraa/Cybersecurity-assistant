{% extends 'base.html.twig' %}

{% block title %}{{ chat.title }} - Code Scanner{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/code_scan.css') }}">
{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 sidebar">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <a href="{{ path('code_scan_index') }}" class="btn-back-sidebar">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
                <button class="btn-delete-sidebar" onclick="deleteChat({{ chat.id }})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>

            <!-- Chat Title with Rename Option -->
            <div class="chat-title-section mb-2">
                <h6 class="text-truncate" id="chat-title">{{ chat.title }}</h6>
                <div id="rename-section" style="display: none;" class="d-flex gap-1">
                    <input type="text" id="rename-input" class="form-control form-control-sm" value="{{ chat.title }}">
                    <button class="btn btn-sm btn-success" onclick="submitRename({{ chat.id }})">✔</button>
                    <button class="btn btn-sm btn-secondary" onclick="cancelRename()">✖</button>
                </div>
                <button class="btn btn-sm btn-outline-primary mt-1" id="rename-btn" onclick="showRename()">Rename</button>
            </div>

            <small>{{ chat.messages|length }} messages</small>
            <hr>

            <form method="post" action="{{ path('code_scan_new_chat') }}">
                <input type="hidden" name="_token" value="{{ csrf_token('new_chat') }}">
                <button type="submit" class="btn-new-scan">
                    <i class="bi bi-plus-circle"></i> New Scan
                </button>
            </form>
        </div>

        <!-- Chat Area -->
        <div class="col-md-9 chat-container">
            <!-- Chat History -->
            <div id="chat-history">
                {% for message in chat.messages %}
                    <div class="message {{ message.role == 'user' ? 'text-end' : 'text-start' }}">
                        <div class="d-inline-block" style="max-width: 80%;">
                            <div class="badge bg-{{ message.role == 'user' ? 'primary' : 'secondary' }}">
                                {{ message.role|capitalize }}
                            </div>
                            <div class="card">
                                <div class="card-body">
                                    <pre>{{ message.content }}</pre>
                                </div>
                                <div class="card-footer">
                                    {{ message.createdAt|date('H:i:s') }}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- Input Form -->
            <div class="input-area">
                <form id="code-form">
                    <input type="hidden" name="_token" value="{{ csrf_token('code_scan') }}">
                    
                    <div class="mb-2">
                        <textarea 
                            id="code" 
                            name="code" 
                            class="form-control" 
                            rows="6" 
                            placeholder="Paste your code here for security analysis..."
                            required></textarea>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <small>Max 20,000 characters</small>
                        <button type="submit" class="btn-scan" id="submit-btn">
                            <i class="bi bi-send"></i> Scan Code
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
/* ====== Chat Messages ====== */
const chatHistory = document.getElementById('chat-history');
const form = document.getElementById('code-form');
const submitBtn = document.getElementById('submit-btn');

chatHistory.scrollTop = chatHistory.scrollHeight;

form.addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(form);
    const code = formData.get('code');

    if (!code.trim()) {
        alert('Please enter some code to scan');
        return;
    }

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Scanning...';

    try {
        const response = await fetch(`{{ path('code_scan_send', {id: chat.id}) }}`, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        const data = await response.json();

        if (data.error) {
            alert(data.error);
            return;
        }

        appendMessage(data.userMessage);
        appendMessage(data.assistantMessage);

        form.reset();
        chatHistory.scrollTop = chatHistory.scrollHeight;

    } catch (err) {
        console.error('Error:', err);
        alert('An error occurred while scanning the code.');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-send"></i> Scan Code';
    }
});

function appendMessage(message) {
    const isUser = message.role === 'user';
    const alignClass = isUser ? 'text-end' : 'text-start';
    const badgeClass = isUser ? 'bg-primary' : 'bg-secondary';

    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${alignClass}`;
    messageDiv.innerHTML = `
        <div class="d-inline-block" style="max-width: 80%;">
            <div class="badge ${badgeClass}">
                ${message.role.charAt(0).toUpperCase() + message.role.slice(1)}
            </div>
            <div class="card">
                <div class="card-body">
                    <pre>${escapeHtml(message.content)}</pre>
                </div>
                <div class="card-footer">
                    ${new Date(message.createdAt).toLocaleTimeString()}
                </div>
            </div>
        </div>
    `;

    chatHistory.appendChild(messageDiv);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

/* ====== Delete Chat ====== */
async function deleteChat(chatId) {
    if (!confirm('Are you sure you want to delete this chat?')) {
        return;
    }

    try {
        const response = await fetch(`/code-scan/chat/${chatId}/delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: '_token={{ csrf_token('delete_chat') }}'
        });

        const data = await response.json();

        if (data.success) {
            window.location.href = '{{ path('code_scan_index') }}';
        }
    } catch (err) {
        console.error('Error:', err);
        alert('Failed to delete chat');
    }
}

/* ====== Rename Chat ====== */
const renameBtn = document.getElementById('rename-btn');
const renameSection = document.getElementById('rename-section');
const chatTitle = document.getElementById('chat-title');

function showRename() {
    renameBtn.style.display = 'none';
    renameSection.style.display = 'flex';
    document.getElementById('rename-input').focus();
}

function cancelRename() {
    renameBtn.style.display = 'inline-block';
    renameSection.style.display = 'none';
    document.getElementById('rename-input').value = chatTitle.textContent;
}

async function submitRename(chatId) {
    const newName = document.getElementById('rename-input').value.trim();
    if (!newName) {
        alert('Chat title cannot be empty');
        return;
    }

    try {
        const formData = new URLSearchParams();
        formData.append('_token', '{{ csrf_token('rename_chat') }}');
        formData.append('title', newName);

        const response = await fetch(`/code-scan/chat/${chatId}/rename`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            chatTitle.textContent = newName;
            cancelRename();
        } else if (data.error) {
            alert(data.error);
        }
    } catch (err) {
        console.error('Error renaming chat:', err);
        alert('Failed to rename chat');
    }
}
</script>
{% endblock %}
